TARGET = libsmartcalc.a
TEST = test

CXX = clang++
AR = ar rcs
RMDIR = rm -rf
RM = rm -f
MKDIR = mkdir -p

CXX_FLAGS = -Wall -Wextra -Werror -std=c++17
TEST_LIBS = /opt/goinfre/ccartman/homebrew/Cellar/googletest/1.14.0/lib/libgtest.a 

INCLUDE_DIR = .
SRC_DIR = .
OBJ_DIR = ${SRC_DIR}/obj
TEST_SRC_DIR = $(SRC_DIR)/tests
TEST_OBJ_DIR = $(OBJ_DIR)/tests

TEST_INCLUDE = /opt/goinfre/ccartman/homebrew/Cellar/googletest/1.14.0/include
INCLUDE = $(wildcard ${INCLUDE_DIR}/*.h)
SRC = $(wildcard ${SRC_DIR}/*.cc)
OBJ = $(addprefix ${OBJ_DIR}/, $(notdir ${SRC:.cc=.o}))
TEST_SRC = $(wildcard ${TEST_SRC_DIR}/*.cc)
TEST_OBJ = $(addprefix ${TEST_OBJ_DIR}/, $(notdir ${TEST_SRC:.cc=.o}))

all: ${TARGET}

${TARGET}: ${OBJ}
	${AR} $@ $?

${TEST}: ${TARGET} ${TEST_OBJ}
	${CXX} -o $@ ${TEST_OBJ} ${TARGET} -I${INCLUDE_DIR} -I${TEST_INCLUDE} ${TEST_LIBS} 
	./${TEST}

${OBJ_DIR}/%.o: ${SRC_DIR}/%.cc ${INCLUDE}
	${MKDIR} ${@D}
	${CXX} ${CXX_FLAGS} -I${INCLUDE_DIR} -I${TEST_INCLUDE} -o $@ -c $<

${TEST_OBJ_DIR}/%.o: ${TEST_SRC_DIR}/%.cc ${INCLUDE}
	${MKDIR} ${@D}
	${CXX} ${CXX_FLAGS} -I${INCLUDE_DIR} -I${TEST_INCLUDE} -o $@ -c $<

clean:
	${RMDIR} ${OBJ_DIR}
	${RM} ${TARGET}
	${RM} ${TEST}

format:
	cp ../../linters/.clang-format .
	clang-format -i ${SRC} ${INCLUDE} ${TEST_SRC}
	rm .clang-format

.PHONY: ${TEST} all clean format
